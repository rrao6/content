{% extends "base.html" %}

{% block title %}New Analysis - Red Zone Analysis{% endblock %}

{% block content %}
<div class="px-4 py-5 sm:px-6 max-w-3xl mx-auto">
    <h2 class="text-2xl font-bold text-gray-900 mb-8">
        <i class="fas fa-play-circle mr-2"></i>
        Run New Analysis
    </h2>
    
    <!-- Analysis Form -->
    <div class="bg-white shadow rounded-lg p-6">
        <form id="analysisForm" class="space-y-6">
            <!-- SOT Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Source of Truth
                </label>
                <div class="space-y-2">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="sot" value="imdb" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2">IMDB</span>
                    </label>
                    <label class="inline-flex items-center ml-6">
                        <input type="checkbox" name="sot" value="rotten_tomatoes" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2">Rotten Tomatoes</span>
                    </label>
                    <label class="inline-flex items-center ml-6">
                        <input type="checkbox" name="sot" value="just_added" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2">Just Added</span>
                    </label>
                    <label class="inline-flex items-center ml-6">
                        <input type="checkbox" name="sot" value="leaving_soon" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2">Leaving Soon</span>
                    </label>
                    <label class="inline-flex items-center ml-6">
                        <input type="checkbox" name="sot" value="most_popular" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2">Most Popular</span>
                    </label>
                </div>
            </div>
            
            <!-- Date Range -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="days_back" class="block text-sm font-medium text-gray-700">
                        Days Back
                    </label>
                    <input type="number" id="days_back" name="days_back" value="7" min="1" max="365"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <p class="mt-1 text-xs text-gray-500">Number of days to look back for eligible titles</p>
                </div>
                
                <div>
                    <label for="limit" class="block text-sm font-medium text-gray-700">
                        Batch Size
                    </label>
                    <input type="number" id="limit" name="limit" value="50" min="1" max="5000"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <p class="mt-1 text-xs text-gray-500">
                        Maximum 5000 posters per batch. Large batches (500+) may take 15-20 minutes with parallel processing.
                    </p>
                </div>
            </div>
            
            <!-- Shiny Toggle -->
            <div class="border rounded-lg p-4 bg-gray-50">
                <h3 class="text-sm font-medium text-gray-800 mb-2">
                    Shiny Titles
                </h3>
                <p class="text-xs text-gray-500 mb-3">
                    Shiny titles are CMS-approved hero posters. Enable this option to only analyze shiny-verified content.
                </p>
                <label class="inline-flex items-center space-x-2">
                    <input type="checkbox" name="shiny_only" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="text-sm text-gray-700">Analyze shiny titles only</span>
                </label>
            </div>
            
            <!-- Description -->
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700">
                    Description (Optional)
                </label>
                <input type="text" id="description" name="description" 
                       placeholder="e.g., Weekly analysis for just added content"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            
            <!-- Advanced Options -->
            <div>
                <button type="button" onclick="toggleAdvanced()" 
                        class="text-sm text-blue-600 hover:text-blue-800">
                    <i class="fas fa-cog mr-1"></i>
                    Advanced Options
                </button>
                
                <div id="advancedOptions" class="hidden mt-4 space-y-4 p-4 bg-gray-50 rounded">
                    <div>
                        <label for="model" class="block text-sm font-medium text-gray-700">
                            Vision Model
                        </label>
                        <select id="model" name="model" 
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="gpt-4o" selected>GPT-4 Vision</option>
                            <option value="gpt-4o-mini">GPT-4 Vision Mini</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="use_cache" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm">Use cached results when available</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="flex justify-end space-x-4">
                <button type="button" onclick="window.history.back()" 
                        class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                    Cancel
                </button>
                <button type="submit" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-play mr-2"></i>
                    Start Analysis
                </button>
            </div>
        </form>
    </div>
    
    <!-- Progress Section (hidden initially) -->
    <div id="progressSection" class="hidden mt-8 bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Analysis Progress</h3>
        
        <div class="mb-4">
            <div class="flex justify-between text-sm text-gray-600 mb-1">
                <span>Processing...</span>
                <span id="progressText">0%</span>
            </div>
            <div class="overflow-hidden h-2 text-xs flex rounded bg-gray-200">
                <div id="progressBar" style="width: 0%" 
                     class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 transition-all duration-300"></div>
            </div>
        </div>
        
        <div id="progressLog" class="mt-4 p-4 bg-gray-50 rounded h-40 overflow-y-auto text-sm font-mono">
            <!-- Progress messages will appear here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const JOB_STORAGE_KEY = 'active_analysis_job';
    let jobPollHandle = null;
    let currentJobId = null;
    
    function toggleAdvanced() {
        const advanced = document.getElementById('advancedOptions');
        advanced.classList.toggle('hidden');
    }
    
    const analysisForm = document.getElementById('analysisForm');
    const progressSection = document.getElementById('progressSection');
    const progressText = document.getElementById('progressText');
    const progressBar = document.getElementById('progressBar');
    const progressLog = document.getElementById('progressLog');
    
    analysisForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const payload = {
            sot_types: [],
            days_back: parseInt(formData.get('days_back'), 10),
            limit: parseInt(formData.get('limit'), 10),
            description: formData.get('description'),
            use_cache: formData.get('use_cache') === 'on',
            shiny_only: formData.get('shiny_only') === 'on'
        };
        
        if (isNaN(payload.days_back) || payload.days_back <= 0) {
            showToast('Please enter a valid number of days to look back.', 'error');
            return;
        }
        if (isNaN(payload.limit) || payload.limit <= 0) {
            payload.limit = undefined;
        }
        
        document.querySelectorAll('input[name="sot"]:checked').forEach(checkbox => {
            payload.sot_types.push(checkbox.value);
        });
        
        if (payload.sot_types.length === 0) {
            showToast('Please select at least one Source of Truth', 'error');
            return;
        }
        
        // Reset progress UI
        progressLog.innerHTML = '';
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
        progressSection.classList.remove('hidden');
        this.style.display = 'none';
        
        try {
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            
            if (result.status === 'accepted' && result.job_id) {
                startJobTracking(result.job_id);
            } else if (result.status === 'success' && result.run_id) {
                appendProgressLog(result.message || 'Analysis completed. Redirecting to results...');
                progressBar.style.width = '100%';
                progressText.textContent = 'Completed';
                setTimeout(() => window.location.href = `/results/${result.run_id}`, 1500);
            } else {
                throw new Error(result.message || 'Analysis failed to start.');
            }
        } catch (error) {
            showToast('Failed to start analysis: ' + error.message, 'error');
            resetProgressUI();
        }
    });
    
    function startJobTracking(jobId, { resumed = false } = {}) {
        currentJobId = jobId;
        localStorage.setItem(JOB_STORAGE_KEY, jobId);
        progressSection.classList.remove('hidden');
        analysisForm.style.display = 'none';
        appendProgressLog(resumed ? 'Resuming analysis progress...' : 'Job accepted. Preparing analysis...');
        startPollingStatus(jobId);
    }
    
    function startPollingStatus(jobId) {
        if (jobPollHandle) {
            clearInterval(jobPollHandle);
        }
        fetchJobStatus(jobId);
        jobPollHandle = setInterval(() => fetchJobStatus(jobId), 2000);
    }
    
    async function fetchJobStatus(jobId) {
        try {
            const response = await fetch(`/api/analyze/status/${jobId}`);
            if (!response.ok) {
                throw new Error('Unable to fetch job status');
            }
            
            const status = await response.json();
            renderProgress(status);
            
            if (status.status === 'completed' && status.run_id) {
                clearInterval(jobPollHandle);
                localStorage.removeItem(JOB_STORAGE_KEY);
                appendProgressLog('Analysis complete. Redirecting to results...');
                setTimeout(() => window.location.href = `/results/${status.run_id}`, 1500);
            } else if (status.status === 'failed') {
                clearInterval(jobPollHandle);
                localStorage.removeItem(JOB_STORAGE_KEY);
                showToast(status.error || 'Analysis failed.', 'error');
                appendProgressLog(status.error || 'Analysis failed.');
                resetProgressUI(true);
            }
        } catch (error) {
            appendProgressLog('Waiting for next update...');
        }
    }
    
    function renderProgress(status) {
        const processed = status.processed || 0;
        const total = status.total || status.processed || 0;
        const percentage = total ? Math.min(100, Math.round((processed / total) * 100)) : 0;
        
        progressText.textContent = total ? `${processed}/${total}` : `${processed}`;
        progressBar.style.width = `${percentage}%`;
        renderLogs(status.logs || []);
    }
    
    function renderLogs(logs) {
        progressLog.innerHTML = '';
        logs.forEach(entry => {
            const div = document.createElement('div');
            div.textContent = `[${new Date(entry.timestamp).toLocaleTimeString()}] ${entry.message}`;
            progressLog.appendChild(div);
        });
        progressLog.scrollTop = progressLog.scrollHeight;
    }
    
    function appendProgressLog(message) {
        const entry = document.createElement('div');
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        progressLog.appendChild(entry);
        progressLog.scrollTop = progressLog.scrollHeight;
    }
    
    function resetProgressUI(keepLogs = false) {
        if (jobPollHandle) {
            clearInterval(jobPollHandle);
            jobPollHandle = null;
        }
        analysisForm.style.display = 'block';
        progressSection.classList.add('hidden');
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
        if (!keepLogs) {
            progressLog.innerHTML = '';
        }
        localStorage.removeItem(JOB_STORAGE_KEY);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const storedJobId = localStorage.getItem(JOB_STORAGE_KEY);
        if (storedJobId) {
            startJobTracking(storedJobId, { resumed: true });
        }
    });
</script>
{% endblock %}
