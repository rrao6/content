{% extends "base.html" %}

{% block title %}New Analysis - Red Zone Analysis{% endblock %}

{% block content %}
<div class="px-4 py-5 sm:px-6 max-w-3xl mx-auto">
    <h2 class="text-2xl font-bold text-gray-900 mb-8">
        <i class="fas fa-play-circle mr-2"></i>
        Run New Analysis
    </h2>
    
    <!-- Analysis Form -->
    <div class="bg-white shadow rounded-lg p-6">
        <form id="analysisForm" class="space-y-6">
            <!-- SOT Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Source of Truth
                </label>
                <div class="space-y-2">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="sot" value="imdb" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2">IMDB</span>
                    </label>
                    <label class="inline-flex items-center ml-6">
                        <input type="checkbox" name="sot" value="rotten_tomatoes" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2">Rotten Tomatoes</span>
                    </label>
                    <label class="inline-flex items-center ml-6">
                        <input type="checkbox" name="sot" value="just_added" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2">Just Added</span>
                    </label>
                    <label class="inline-flex items-center ml-6">
                        <input type="checkbox" name="sot" value="leaving_soon" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2">Leaving Soon</span>
                    </label>
                    <label class="inline-flex items-center ml-6">
                        <input type="checkbox" name="sot" value="most_popular" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2">Most Popular</span>
                    </label>
                </div>
            </div>
            
            <!-- Date Range -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="days_back" class="block text-sm font-medium text-gray-700">
                        Days Back
                    </label>
                    <input type="number" id="days_back" name="days_back" value="7" min="1" max="365"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <p class="mt-1 text-xs text-gray-500">Number of days to look back for eligible titles</p>
                </div>
                
                <div>
                    <label for="limit" class="block text-sm font-medium text-gray-700">
                        Batch Size
                    </label>
                    <input type="number" id="limit" name="limit" value="50" min="1" max="100"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <p class="mt-1 text-xs text-gray-500">
                        Maximum 100 posters per batch for QA. Start with smaller batches (25-50) to optimize.
                    </p>
                </div>
            </div>
            
            <!-- Description -->
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700">
                    Description (Optional)
                </label>
                <input type="text" id="description" name="description" 
                       placeholder="e.g., Weekly analysis for just added content"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            
            <!-- Advanced Options -->
            <div>
                <button type="button" onclick="toggleAdvanced()" 
                        class="text-sm text-blue-600 hover:text-blue-800">
                    <i class="fas fa-cog mr-1"></i>
                    Advanced Options
                </button>
                
                <div id="advancedOptions" class="hidden mt-4 space-y-4 p-4 bg-gray-50 rounded">
                    <div>
                        <label for="model" class="block text-sm font-medium text-gray-700">
                            Vision Model
                        </label>
                        <select id="model" name="model" 
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="gpt-4o" selected>GPT-4 Vision</option>
                            <option value="gpt-4o-mini">GPT-4 Vision Mini</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="use_cache" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm">Use cached results when available</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="flex justify-end space-x-4">
                <button type="button" onclick="window.history.back()" 
                        class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                    Cancel
                </button>
                <button type="submit" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-play mr-2"></i>
                    Start Analysis
                </button>
            </div>
        </form>
    </div>
    
    <!-- Progress Section (hidden initially) -->
    <div id="progressSection" class="hidden mt-8 bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Analysis Progress</h3>
        
        <div class="mb-4">
            <div class="flex justify-between text-sm text-gray-600 mb-1">
                <span>Processing...</span>
                <span id="progressText">0%</span>
            </div>
            <div class="overflow-hidden h-2 text-xs flex rounded bg-gray-200">
                <div id="progressBar" style="width: 0%" 
                     class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 transition-all duration-300"></div>
            </div>
        </div>
        
        <div id="progressLog" class="mt-4 p-4 bg-gray-50 rounded h-40 overflow-y-auto text-sm font-mono">
            <!-- Progress messages will appear here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function toggleAdvanced() {
        const advanced = document.getElementById('advancedOptions');
        advanced.classList.toggle('hidden');
    }
    
    document.getElementById('analysisForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Get form data
        const formData = new FormData(this);
        const data = {};
        
        // Get selected SOTs
        data.sot_types = [];
        document.querySelectorAll('input[name="sot"]:checked').forEach(checkbox => {
            data.sot_types.push(checkbox.value);
        });
        
        if (data.sot_types.length === 0) {
            showToast('Please select at least one Source of Truth', 'error');
            return;
        }
        
        // Get other fields
        data.days_back = parseInt(formData.get('days_back'));
        data.limit = parseInt(formData.get('limit'));
        data.description = formData.get('description');
        data.model = formData.get('model');
        data.use_cache = formData.get('use_cache') === 'on';
        
        // Show progress section
        document.getElementById('progressSection').classList.remove('hidden');
        this.style.display = 'none';
        
        // Start progress simulation
        const progressInterval = simulateProgress();
        
        // Start analysis
        try {
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // Stop progress simulation
                clearInterval(progressInterval);
                
                // Update progress
                updateProgress(100, result.message || 'Analysis completed successfully!');
                
                // Show completion message
                if (result.is_demo) {
                    updateProgress(100, 'Demo data generated. Redirecting to results...');
                }
                
                // Redirect to results
                setTimeout(() => {
                    if (result.run_id) {
                        window.location.href = `/results/${result.run_id}`;
                    } else {
                        window.location.href = '/results';
                    }
                }, 2000);
            } else {
                throw new Error(result.message || 'Analysis failed');
            }
            
        } catch (error) {
            showToast('Failed to start analysis: ' + error.message, 'error');
            this.style.display = 'block';
            document.getElementById('progressSection').classList.add('hidden');
        }
    });
    
    function updateProgress(percentage, message) {
        document.getElementById('progressText').textContent = percentage + '%';
        document.getElementById('progressBar').style.width = percentage + '%';
        
        if (message) {
            const log = document.getElementById('progressLog');
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
    }
    
    // Progress simulation
    function simulateProgress() {
        let progress = 0;
        const messages = [
            'Initializing analysis...',
            'Fetching eligible titles...',
            'Downloading poster images...',
            'Running AI analysis...',
            'Processing results...',
            'Saving to database...'
        ];
        
        let messageIndex = 0;
        const progressInterval = setInterval(() => {
            if (document.getElementById('progressSection').classList.contains('hidden')) {
                clearInterval(progressInterval);
                return;
            }
            
            progress += Math.random() * 20;
            if (progress > 90) progress = 90;
            
            if (progress > messageIndex * 15 && messageIndex < messages.length) {
                updateProgress(Math.floor(progress), messages[messageIndex]);
                messageIndex++;
            }
        }, 800);
        
        return progressInterval;
    }
</script>
{% endblock %}
